<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KPIs Esenciales â€” GestiÃ³n Comercial</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Montserrat', sans-serif; background-color: #f9f9f9; padding: 40px 0; }
    .container { max-width: 780px; background: #fff; margin: auto; padding: 40px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,.08); }
    .logo { display: block; margin: 0 auto 20px; max-width: 180px; }
    h1 { color: #fa345e; text-align: center; margin-bottom: 10px; font-size: 26px; }
    .subtitle { text-align: center; color: #666; margin-bottom: 30px; font-size: 14px; }
    label { display: block; margin: 16px 0 6px; font-weight: 600; color: #222; }
    input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px; box-sizing: border-box; font-family: 'Montserrat', sans-serif; }
    select { background-color: #fef2f3; }
    select[multiple] { background-color: #fef2f3; min-height: 160px; }
    textarea { resize: vertical; min-height: 80px; }
    button { background-color: #fa345e; color: white; border: none; padding: 12px 18px; border-radius: 8px; font-size: 16px; cursor: pointer; margin-top: 24px; width: 100%; font-family: 'Montserrat', sans-serif; font-weight: 600; }
    button:disabled { background-color: #ccc; cursor: not-allowed; }
    .block { border: 1px solid #eee; border-radius: 12px; padding: 18px; margin-top: 18px; background: #fff; }
    .block h3 { color: #fa345e; margin: 0 0 14px 0; font-size: 16px; }
    .error { background: #fff3cd; border: 1px solid #ffeeba; color: #856404; border-radius: 8px; padding: 10px; margin-top: 12px; display: none; font-size: 13px; }
    .success { background: #eaf7ea; border: 1px solid #cfe9cf; color: #256b25; border-radius: 8px; padding: 10px; margin-top: 12px; display: none; font-size: 13px; }
    hr { border: none; border-top: 1px solid #eee; margin: 26px 0; }
    .operacion-display { background: #eaf7ea; border: 1px solid #cfe9cf; color: #256b25; border-radius: 8px; padding: 10px 14px; margin-top: 6px; font-size: 14px; font-weight: 600; min-height: 38px; }
    .hint { color: #999; font-size: 12px; margin-top: 4px; }
  </style>
</head>
<body>
  <div class="container">
    <img src="https://estudios.apprecio.com/hubfs/logos/Apprecio-logo-rojo.png" class="logo" />
    <h1>KPIs Esenciales â€” GestiÃ³n Comercial</h1>
    <div class="subtitle">Identifica las necesidades por Ã¡rea que impactan en tu gestiÃ³n comercial.</div>

    <form id="kpisForm">
      <label>Â¿QuiÃ©n eres?</label>
      <select id="nombreSelect" required>
        <option value="">Cargando colaboradores...</option>
      </select>

      <label>OperaciÃ³n asignada</label>
      <div class="operacion-display" id="operacionDisplay">â€”</div>

      <hr />

      <label>Elige la o las Ã¡reas que impactan en tu gestiÃ³n comercial</label>
      <select id="areasSelect" multiple required>
        <option value="People">People</option>
        <option value="Marketing">Marketing</option>
        <option value="Operations">Operations</option>
        <option value="Finance">Finance</option>
        <option value="Brand">Brand</option>
        <option value="Product">Product</option>
        <option value="IT">IT</option>
      </select>
      <div class="hint">ðŸ’¡ MantÃ©n presionado Ctrl (o Cmd en Mac) para seleccionar varias Ã¡reas</div>

      <div id="preguntasAreas"></div>

      <div class="error" id="errorBox"></div>
      <div class="success" id="successBox"></div>

      <button type="submit" id="submitBtn">âœ… Enviar</button>
    </form>
  </div>

<script>
  var SHEET_URL = "https://docs.google.com/spreadsheets/d/1nLktyBlmM1-NdRLVywPlNiUJwBCaOC26ONpgPTSxv-w/gviz/tq?tqx=out:json&sheet=Colaboradores";
  var WEBHOOK_URL = "https://n8n.openip.cl/webhook/kpis esenciales";

  var errorBox = document.getElementById("errorBox");
  var successBox = document.getElementById("successBox");
  var submitBtn = document.getElementById("submitBtn");
  var colaboradores = {};

  function showError(msg) {
    errorBox.textContent = msg;
    errorBox.style.display = "block";
    successBox.style.display = "none";
  }

  function showSuccess(msg) {
    successBox.textContent = msg;
    successBox.style.display = "block";
    errorBox.style.display = "none";
  }

  function renderPreguntas() {
    var areasSelect = document.getElementById("areasSelect");
    var areas = [];
    for (var i = 0; i < areasSelect.options.length; i++) {
      if (areasSelect.options[i].selected) {
        areas.push(areasSelect.options[i].value);
      }
    }

    var contenedor = document.getElementById("preguntasAreas");
    contenedor.innerHTML = "";

    var etapas = ["ProspecciÃ³n", "CalificaciÃ³n", "Propuesta", "NegociaciÃ³n", "Cierre", "Postventa"];

    for (var j = 0; j < areas.length; j++) {
      var area = areas[j];
      var areaId = area.replace(/[^a-zA-Z0-9]/g, "_");

      var etapasOpts = '<option value="">-- Selecciona --</option>';
      for (var k = 0; k < etapas.length; k++) {
        etapasOpts += '<option value="' + etapas[k] + '">' + etapas[k] + '</option>';
      }

      var block = document.createElement("div");
      block.className = "block";
      block.innerHTML =
        '<h3>ðŸ“Œ ' + area + '</h3>' +
        '<label>Â¿QuÃ© necesitas de esta Ã¡rea? <span style="font-weight:400;color:#666">(describe concretamente el entregable/acciÃ³n)</span></label>' +
        '<textarea id="' + areaId + '_necesitas" placeholder="Describe el entregable o acciÃ³n concreta..."></textarea>' +
        '<label>Â¿En quÃ© etapa del ciclo comercial impacta?</label>' +
        '<select id="' + areaId + '_etapa">' + etapasOpts + '</select>' +
        '<label>Impacto esperado en tu gestiÃ³n</label>' +
        '<textarea id="' + areaId + '_impacto" placeholder="Â¿QuÃ© mejora o resultado esperas?"></textarea>' +
        '<label>Â¿QuÃ© KPI propones para esta Ã¡rea?</label>' +
        '<input type="text" id="' + areaId + '_kpi" placeholder="Ej: Tasa de conversiÃ³n, tiempo de respuesta..." />';

      contenedor.appendChild(block);
    }
  }

  // Cargar colaboradores
  fetch(SHEET_URL)
    .then(function(r) { return r.text(); })
    .then(function(text) {
      var json = JSON.parse(text.substring(47).slice(0, -2));
      var rows = json.table.rows;
      var select = document.getElementById("nombreSelect");
      select.innerHTML = '<option value="">-- Selecciona --</option>';
      for (var i = 0; i < rows.length; i++) {
        var nombre = rows[i].c[0] ? rows[i].c[0].v : null;
        var operacion = rows[i].c[1] ? rows[i].c[1].v : null;
        if (nombre && nombre !== "Nombre") {
          colaboradores[nombre] = operacion;
          var opt = document.createElement("option");
          opt.value = nombre;
          opt.textContent = nombre;
          select.appendChild(opt);
        }
      }
    })
    .catch(function(err) {
      showError("Error al cargar colaboradores: " + err.message);
      document.getElementById("nombreSelect").innerHTML = '<option value="">Error cargando datos</option>';
    });

  document.getElementById("nombreSelect").addEventListener("change", function() {
    document.getElementById("operacionDisplay").textContent = colaboradores[this.value] || "â€”";
  });

  document.getElementById("areasSelect").addEventListener("change", renderPreguntas);

  document.getElementById("kpisForm").addEventListener("submit", function(e) {
    e.preventDefault();
    errorBox.style.display = "none";
    successBox.style.display = "none";

    var nombre = document.getElementById("nombreSelect").value;
    var operacion = document.getElementById("operacionDisplay").textContent;
    var areasSelect = document.getElementById("areasSelect");
    var areas = [];
    for (var i = 0; i < areasSelect.options.length; i++) {
      if (areasSelect.options[i].selected) areas.push(areasSelect.options[i].value);
    }

    if (!nombre) { showError("Por favor selecciona un colaborador."); return; }
    if (areas.length === 0) { showError("Por favor selecciona al menos un Ã¡rea."); return; }

    submitBtn.disabled = true;
    submitBtn.textContent = "Enviando...";

    var promises = areas.map(function(area) {
      var areaId = area.replace(/[^a-zA-Z0-9]/g, "_");
      var payload = {
        nombre: nombre,
        operacion: operacion,
        area: area,
        que_necesitas: document.getElementById(areaId + "_necesitas") ? document.getElementById(areaId + "_necesitas").value : "",
        etapa: document.getElementById(areaId + "_etapa") ? document.getElementById(areaId + "_etapa").value : "",
        impacto: document.getElementById(areaId + "_impacto") ? document.getElementById(areaId + "_impacto").value : "",
        kpi: document.getElementById(areaId + "_kpi") ? document.getElementById(areaId + "_kpi").value : ""
      };
      return fetch(WEBHOOK_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
    });

    Promise.all(promises)
      .then(function() {
        showSuccess("âœ… Â¡Formulario enviado correctamente!");
        submitBtn.textContent = "âœ… Enviar";
        submitBtn.disabled = false;
        setTimeout(function() {
          document.getElementById("kpisForm").reset();
          document.getElementById("operacionDisplay").textContent = "â€”";
          document.getElementById("preguntasAreas").innerHTML = "";
          successBox.style.display = "none";
        }, 2500);
      })
      .catch(function(err) {
        showError("âŒ Error al enviar: " + err.message);
        submitBtn.textContent = "âœ… Enviar";
        submitBtn.disabled = false;
      });
  });
</script>
</body>
</html>
